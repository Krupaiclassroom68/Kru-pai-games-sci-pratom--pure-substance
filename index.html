<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡πÄ‡∏Å‡∏°‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå‚Äì‡∏™‡∏≤‡∏£‡∏ú‡∏™‡∏° | Kru Pai Classroom</title>
<style>
  :root{ --brand:#e63946; --ink:#111; --muted:#666; --card:#f7f7f8; --accent:#1d4ed8; --ok:#16a34a; --bad:#dc2626; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,TH Sarabun New,Prompt,sans-serif;color:var(--ink);background:linear-gradient(180deg,#fff,#f3f4f6)}
  .wrap{max-width:960px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
  .brand{font-weight:800;letter-spacing:.2px;color:var(--brand)}
  .card{background:var(--card);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:20px}
  h1{font-size:clamp(22px,3.4vw,34px);margin:0 0 6px}
  h2{font-size:clamp(18px,2.6vw,24px);margin:0 0 12px}
  p{margin:6px 0;color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input[type=text]{width:260px;padding:12px 14px;border:2px solid #e5e7eb;border-radius:14px;font-size:16px}
  button{appearance:none;border:0;border-radius:14px;padding:12px 16px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--brand);color:#fff}
  .btn-ghost{background:#fff;border:2px solid #e5e7eb}
  .btn-next{background:var(--accent);color:#fff}
  .toolbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin:10px 0 16px;flex-wrap:wrap}
  .timer{display:flex;align-items:center;gap:10px}
  .timebar{flex:1;height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .timebar>span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444);width:100%}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  .item{display:flex;gap:10px;align-items:flex-start;background:#fff;border:2px solid #e5e7eb;border-radius:14px;padding:12px}
  .check{--size:24px;min-width:var(--size);height:var(--size);border-radius:8px;border:2px solid #cbd5e1;display:inline-grid;place-items:center;cursor:pointer;user-select:none;flex:0 0 var(--size);font-size:16px}
  .check.active{background:#0ea5e9;border-color:#0284c7;color:#fff}
  .note{font-size:13px;color:#475569}
  .mark-ok{border-color:var(--ok)}
  .mark-bad{border-color:var(--bad)}
  .foot{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;margin-top:12px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#fff;border:2px solid #e5e7eb}
  .score{font-size:20px;font-weight:900}
  .center{text-align:center}
  .hidden{display:none !important}
  .two-col{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:720px){.two-col{grid-template-columns:1fr 1fr}}
  .row-line{display:flex;align-items:center;gap:10px;background:#fff;border:2px solid #e5e7eb;border-radius:14px;padding:10px 12px}
  .row-line .name{font-weight:700}
  .table{width:100%;border-collapse:separate;border-spacing:0 10px}
  .table td{padding:10px 12px;background:#fff;border:2px solid #e5e7eb}
  .table tr td:first-child{border-radius:14px 0 0 14px}
  .table tr td:last-child{border-radius:0 14px 14px 0}
  .right{margin-left:auto}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="brand">Kru Pai Classroom</div>
      <div class="pill"><span>üß™</span><strong>‡πÄ‡∏Å‡∏°‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå‚Äì‡∏™‡∏≤‡∏£‡∏ú‡∏™‡∏°</strong></div>
    </div>
    
  </header>

  <section id="home" class="card">
    <h1>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏°!</h1>
    <p>‡πÇ‡∏´‡∏°‡∏î 3 ‡∏î‡πà‡∏≤‡∏ô ‚Ä¢ ‡∏î‡πà‡∏≤‡∏ô‡∏•‡∏∞ <strong>3 ‡∏ô‡∏≤‡∏ó‡∏µ</strong> ‚Ä¢ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ‡∏ñ‡∏π‡∏Å <strong>+2</strong> | ‡∏ú‡∏¥‡∏î <strong>-1</strong> ‚Ä¢ ‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô ‚â• 70%</p>
    <div class="row" style="margin:10px 0 14px">
      <input id="player" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô..." />
      <button class="btn-primary" id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° ‚ñ∂</button>
    </div>
    <div class="note">‡∏î‡πà‡∏≤‡∏ô 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå‚Äù ‚Ä¢ ‡∏î‡πà‡∏≤‡∏ô 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏™‡∏≤‡∏£‡∏ú‡∏™‡∏°‚Äù ‚Ä¢ ‡∏î‡πà‡∏≤‡∏ô 3: ‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå/‡∏ú‡∏™‡∏° ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å</div>
  </section>

  <section id="play" class="card hidden">
    <div class="toolbar">
      <div>
        <h2 id="roundTitle">‡∏î‡πà‡∏≤‡∏ô 1 ‚Ä¢ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå</h2>
        <div class="note" id="roundHint">‡∏à‡∏á‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå‚Äù</div>
      </div>
      <div class="timer" style="min-width:220px;">
        <div class="timebar"><span id="timebar"></span></div>
        <div class="pill"><strong id="clock">03:00</strong></div>
      </div>
      <div class="pill right hidden" id="roundScorePill">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ: <b id="roundScoreText">0/0</b></div>
      <div class="pill right hidden" id="passNote"></div>
    </div>

    <div id="round1" class="grid"></div>
    <div id="round2" class="grid hidden"></div>
    <div id="round3" class="two-col hidden"></div>

    <div class="foot">
      <button class="btn-ghost" id="resetBtn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏î‡πà‡∏≤‡∏ô</button>
      <button class="btn-primary" id="submitBtn">‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‚úÖ</button>
      <button class="btn-next hidden" id="nextBtn">‡πÑ‡∏õ‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûú</button>
    </div>
  </section>

  <section id="summary" class="card hidden center">
    <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ‚Ä¢ <span id="playerName">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</span></h2>
    <div class="score">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <span id="totalScore">0</span> / <span id="totalMax">0</span> (<span id="totalPercent">0</span>%)</div>
    <table class="table" style="margin-top:10px">
      <tr><td>‡∏î‡πà‡∏≤‡∏ô 1 ‚Ä¢ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå</td><td id="t1">0</td></tr>
      <tr><td>‡∏î‡πà‡∏≤‡∏ô 2 ‚Ä¢ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏™‡∏≤‡∏£‡∏ú‡∏™‡∏°</td><td id="t2">0</td></tr>
      <tr><td>‡∏î‡πà‡∏≤‡∏ô 3 ‚Ä¢ ‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå/‡∏ú‡∏™‡∏° ‡∏ï‡πà‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£</td><td id="t3">0</td></tr>
      <tr><td><strong>‡∏£‡∏ß‡∏°</strong></td><td id="t4"><strong>0</strong></td></tr>
    </table>
    <div id="historyBlock" class="seg hidden">
      <h3 style="margin:8px 0">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
      <table class="table" id="historyTable"></table>
    </div>
    <div class="foot center" style="justify-content:center">
      <button class="btn-primary" id="replay">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á üîÅ</button>
    </div>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const $ = (q)=>document.querySelector(q);
  const el = (tag, cls, html)=>{ const d=document.createElement(tag); if(cls) d.className=cls; if(html!==undefined) d.innerHTML=html; return d; };
  const shuffle = (arr)=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);

  // ---------- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πà‡∏≤‡∏ô ----------
  const pureProps = [
    ["‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏ò‡∏≤‡∏ï‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö)", true],
    ["‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏î‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏Ñ‡∏á‡∏ó‡∏µ‡πà)", true],
    ["‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏´‡∏•‡∏≠‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏Ñ‡∏á‡∏ó‡∏µ‡πà", true],
    ["‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ", true],
    ["‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏Ñ‡∏á‡∏ó‡∏µ‡πà", true],
    ["‡∏°‡∏µ‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô", true],
    ["‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢", false],
    ["‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö", false],
    ["‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏≤‡∏£‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ä‡∏ô‡∏¥‡∏î", false],
    ["‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô", false],
  ];
  const mixProps = [
    ["‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 2 ‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ", true],
    ["‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏î‡πâ", true],
    ["‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏î/‡∏à‡∏∏‡∏î‡∏´‡∏•‡∏≠‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÑ‡∏°‡πà‡∏Ñ‡∏á‡∏ó‡∏µ‡πà", true],
    ["‡πÅ‡∏¢‡∏Å‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏≠‡∏á, ‡∏Å‡∏•‡∏±‡πà‡∏ô, ‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏°‡πà‡πÄ‡∏´‡∏•‡πá‡∏Å)", true],
    ["‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏£‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ú‡∏™‡∏°", true],
    ["‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö", true],
    ["‡∏°‡∏µ‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô", true],
    ["‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏≠‡∏≤‡∏Å‡∏≤‡∏® ‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠ ‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏Å‡∏•‡πâ‡∏≤", true],
    ["‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏≠‡∏ô‡∏∏‡∏†‡∏≤‡∏Ñ‡∏ö‡∏≤‡∏á‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏î‡πâ", true],
    ["‡∏°‡∏µ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß", false],
  ];
  const substances = [
    ["‡∏ô‡πâ‡∏≥‡∏Å‡∏•‡∏±‡πà‡∏ô", "pure"],
    ["‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏•", "mix"],
    ["‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°‡∏Ñ‡∏±‡πâ‡∏ô", "mix"],
    ["‡∏≠‡∏≤‡∏Å‡∏≤‡∏®", "mix"],
    ["‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô", "pure"],
    ["‡πÄ‡∏´‡∏•‡πá‡∏Å", "pure"],
    ["‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏Å‡∏•‡πâ‡∏≤", "mix"],
    ["‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡∏•‡∏∑‡∏≠", "mix"],
    ["‡∏ã‡∏π‡πÇ‡∏Ñ‡∏£‡∏™", "pure"],
    ["‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô‡πÑ‡∏î‡∏≠‡∏≠‡∏Å‡πÑ‡∏ã‡∏î‡πå", "pure"],
  ];

  const MAX1 = pureProps.filter(x=>x[1]).length * 2;   // 12
  const MAX2 = mixProps.filter(x=>x[1]).length * 2;    // 18
  const MAX3 = substances.length * 2;                  // 20
  const TOTAL_MAX = MAX1 + MAX2 + MAX3;                // 50

  let currentRound = 1;
  let scores = {1:0,2:0,3:0};
  let timer = null;
  const ROUND_SECONDS = 180;
  let left = ROUND_SECONDS;

  // --- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (Summary ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ---
  let gameHistory = [];
  const HISTORY_KEY = 'kp_history_pure_mix';
  try { const raw = localStorage.getItem(HISTORY_KEY); if(raw) gameHistory = JSON.parse(raw); } catch(e) {}
  function saveHistory(){ try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(gameHistory)); }catch(e){} }
  function renderHistory(){
    const blk = $('#historyBlock');
    const tbl = $('#historyTable');
    if(!gameHistory.length){ blk.classList.add('hidden'); return; }
    blk.classList.remove('hidden');
    tbl.innerHTML = '';
    const head = document.createElement('tr');
    head.innerHTML = '<td><b>‡∏£‡∏≠‡∏ö</b></td><td><b>‡∏î‡πà‡∏≤‡∏ô 1</b></td><td><b>‡∏î‡πà‡∏≤‡∏ô 2</b></td><td><b>‡∏î‡πà‡∏≤‡∏ô 3</b></td><td><b>‡∏£‡∏ß‡∏°</b></td><td><b>%</b></td>';
    tbl.appendChild(head);
    gameHistory.forEach((h,idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>'+ (idx+1) +'</td><td>'+h.s1+'</td><td>'+h.s2+'</td><td>'+h.s3+'</td><td>'+h.total+'</td><td>'+h.percent+'%</td>';
      tbl.appendChild(tr);
    });
  }

  function buildPropRound(containerId, data){
    const box = $(containerId); box.innerHTML='';
    shuffle(data).forEach((pair, idx)=>{
      const text = pair[0], isTrue = pair[1];
      const row = el('div','item');
      const boxBtn = el('div','check'); boxBtn.setAttribute('role','checkbox'); boxBtn.dataset.answer = isTrue ? 'true' : 'false';
      boxBtn.addEventListener('click', ()=> boxBtn.classList.toggle('active'));
      const txt = el('div','', '<div><strong>'+(idx+1)+'.</strong> '+text+'</div><div class="note">‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πà</div>');
      row.appendChild(boxBtn); row.appendChild(txt);
      box.appendChild(row);
    });
  }
  function buildSubstanceRound(){
    const box = $('#round3'); box.innerHTML='';
    shuffle(substances).forEach((pair, i)=>{
      const name = pair[0], key = pair[1];
      const row = el('div','row-line');
      const title = el('div','name', '<span>'+(i+1)+'.</span> '+name);
      const ops = el('div','', '<label class="opt"><input type="radio" name="s'+i+'" value="pure"> ‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå</label> <label class="opt"><input type="radio" name="s'+i+'" value="mix"> ‡∏ú‡∏™‡∏°</label>');
      row.dataset.answer = key;
      row.appendChild(title); row.appendChild(ops);
      box.appendChild(row);
    });
  }

  function startTimer(){
    clearInterval(timer);
    left = ROUND_SECONDS; updateClock();
    timer = setInterval(()=>{
      left--; updateClock();
      if(left<=0){ clearInterval(timer); autoSubmit(); }
    },1000);
  }
  function updateClock(){
    const m = String(Math.floor(left/60)).padStart(2,'0');
    const s = String(left%60).padStart(2,'0');
    $('#clock').textContent = m+':'+s;
    $('#timebar').style.width = Math.max(0, left/ROUND_SECONDS*100)+'%';
  }

  function gradeRound(){
    let earned = 0, max = 0;
    scores[currentRound] = 0; // reset this round score before grading
    if(currentRound===1 || currentRound===2){
      const container = currentRound===1 ? '#round1' : '#round2';
      max = currentRound===1 ? MAX1 : MAX2;
      document.querySelectorAll(container+' .item').forEach(item=>{
        const boxBtn = item.querySelector('.check');
        const picked = boxBtn.classList.contains('active');
        const isTrue = (boxBtn.dataset.answer==='true');
        if(picked && isTrue){ earned += 2; item.classList.add('mark-ok'); }
        if(picked && !isTrue){ earned -= 1; item.classList.add('mark-bad'); }
      });
      scores[currentRound] = earned;
    }else{
      max = MAX3;
      document.querySelectorAll('#round3 .row-line').forEach(row=>{
        const ans = row.dataset.answer;
        const radios = row.querySelectorAll('input[type=radio]');
        let picked = null; radios.forEach(r=>{ if(r.checked) picked = r.value; });
        if(!picked) return;
        if(picked===ans){ earned += 2; row.classList.add('mark-ok'); }
        else{ earned -= 1; row.classList.add('mark-bad'); }
      });
      scores[3] = earned;
    }
    return {earned, max};
  }

  function showRoundScore(earned, max){
    $('#roundScoreText').textContent = earned + '/' + max;
    $('#roundScorePill').classList.remove('hidden');
  }

  function lockRound(canNext){
    $('#submitBtn').classList.add('hidden');
    const note = $('#passNote');
    if(canNext){
      $('#nextBtn').classList.remove('hidden');
      note.textContent = '‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå 70% ‚úì ‡πÑ‡∏õ‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ';
      note.classList.remove('hidden');
    }else{
      $('#nextBtn').classList.add('hidden');
      note.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 70% ‚Üí ‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
      note.classList.remove('hidden');
    }
    if(currentRound===1 || currentRound===2){
      document.querySelectorAll((currentRound===1?'#round1':'#round2')+' .check').forEach(c=> c.style.pointerEvents='none');
    }else{
      document.querySelectorAll('#round3 input[type=radio]').forEach(r=> r.disabled = true);
    }
  }

  function autoSubmit(){
    if($('#play').classList.contains('hidden')) return;
    const res = gradeRound();
    showRoundScore(res.earned, res.max);
    const pass = res.earned >= Math.ceil(0.7*res.max);
    lockRound(pass);
  }

  function showRound(n){
    currentRound = n;
    $('#roundScorePill').classList.add('hidden');
    $('#passNote').classList.add('hidden');
    $('#roundTitle').textContent = (n===1?'‡∏î‡πà‡∏≤‡∏ô 1 ‚Ä¢ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå': n===2?'‡∏î‡πà‡∏≤‡∏ô 2 ‚Ä¢ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏£‡∏ú‡∏™‡∏°':'‡∏î‡πà‡∏≤‡∏ô 3 ‚Ä¢ ‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå / ‡∏ú‡∏™‡∏° ‡∏ï‡πà‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£');
    $('#roundHint').textContent = (n===1?'‡∏à‡∏á‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå‚Äù': n===2?'‡∏à‡∏á‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏™‡∏≤‡∏£‡∏ú‡∏™‡∏°‚Äù':'‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏ö‡∏£‡∏¥‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πå‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏ú‡∏™‡∏°‚Äù');
    $('#round1').classList.toggle('hidden', n!==1);
    $('#round2').classList.toggle('hidden', n!==2);
    $('#round3').classList.toggle('hidden', n!==3);
    $('#submitBtn').classList.remove('hidden');
    $('#nextBtn').classList.add('hidden');
    document.querySelectorAll('.mark-ok,.mark-bad').forEach(e=>{ e.classList.remove('mark-ok','mark-bad'); });
    if(n===1){ buildPropRound('#round1', pureProps); }
    if(n===2){ buildPropRound('#round2', mixProps); }
    if(n===3){ buildSubstanceRound(); }
    startTimer();
  }

  // Events
  $('#startBtn').addEventListener('click', ()=>{
    const name = $('#player').value.trim() || '‡∏ô‡∏±‡∏Å‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢';
    $('#playerName').textContent = name;
    $('#home').classList.add('hidden');
    $('#play').classList.remove('hidden');
    scores = {1:0,2:0,3:0};
    showRound(1);
    renderHistory();
  });

  $('#submitBtn').addEventListener('click', ()=>{
    clearInterval(timer);
    const res = gradeRound();
    showRoundScore(res.earned, res.max);
    const pass = res.earned >= Math.ceil(0.7*res.max);
    lockRound(pass);
  });

  $('#nextBtn').addEventListener('click', ()=>{
    if(currentRound<3){ showRound(currentRound+1); }
    else{
      const total = scores[1]+scores[2]+scores[3];
      const percent = Math.max(0, Math.round(total/TOTAL_MAX*100));
      $('#totalScore').textContent = total;
      $('#totalMax').textContent = TOTAL_MAX;
      $('#totalPercent').textContent = percent;
      $('#t1').textContent = scores[1]+' / '+MAX1;
      $('#t2').textContent = scores[2]+' / '+MAX2;
      $('#t3').textContent = scores[3]+' / '+MAX3;
      $('#t4').textContent = total+' / '+TOTAL_MAX+' ('+percent+'%)';
      gameHistory.push({ s1: scores[1]+' / '+MAX1, s2: scores[2]+' / '+MAX2, s3: scores[3]+' / '+MAX3, total: total+' / '+TOTAL_MAX, percent });
      saveHistory(); renderHistory();
      $('#play').classList.add('hidden'); $('#summary').classList.remove('hidden');
    }
  });

  $('#resetBtn').addEventListener('click', ()=>{
    scores[currentRound] = 0;
    if(currentRound===1) buildPropRound('#round1', pureProps);
    if(currentRound===2) buildPropRound('#round2', mixProps);
    if(currentRound===3) buildSubstanceRound();
    document.querySelectorAll('.mark-ok,.mark-bad').forEach(e=>{ e.classList.remove('mark-ok','mark-bad'); });
    $('#submitBtn').classList.remove('hidden');
    $('#nextBtn').classList.add('hidden');
    $('#roundScorePill').classList.add('hidden');
    $('#passNote').classList.add('hidden');
    startTimer();
  });

  $('#replay').addEventListener('click', ()=>{
    $('#summary').classList.add('hidden');
    $('#home').classList.remove('hidden');
    renderHistory();
  });

  document.addEventListener('mousedown', e=>{ if(e.detail>1) e.preventDefault(); }, false);
});
</script>
</body>
</html>
